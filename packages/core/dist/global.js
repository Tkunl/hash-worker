!function(A,e,t){"use strict";class r{_value;subscribers=new Map;constructor(A){this._value=A}get value(){return this._value}next(A){this._value=A,this.subscribers.forEach(e=>e(A))}subscribe(A){let e="xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(A){let e=16*Math.random()|0;return("x"===A?e:3&e|8).toString(16)});return this.subscribers.set(e,A),A(this.value),e}unsubscribe(A){this.subscribers.delete(A)}}async function i(A){return Promise.all(A.map(A=>A.arrayBuffer()))}/*!
   * hash-wasm (https://www.npmjs.com/package/hash-wasm)
   * (c) Dani Biro
   * @license MIT
   */function n(A,e,t,r){return new(t||(t=Promise))(function(e,i){function n(A){try{o(r.next(A))}catch(A){i(A)}}function a(A){try{o(r.throw(A))}catch(A){i(A)}}function o(A){var r;A.done?e(A.value):((r=A.value)instanceof t?r:new t(function(A){A(r)})).then(n,a)}o((r=r.apply(A,[])).next())})}"function"==typeof SuppressedError&&SuppressedError;class a{constructor(){this.mutex=Promise.resolve()}lock(){let A=()=>{};return this.mutex=this.mutex.then(()=>new Promise(A)),new Promise(e=>{A=e})}dispatch(A){return n(this,void 0,void 0,function*(){let e=yield this.lock();try{return yield Promise.resolve(A())}finally{e()}})}}let o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:global,B=null!==(u=o.Buffer)&&void 0!==u?u:null,s=o.TextEncoder?new o.TextEncoder:null;function g(A,e){return(15&A)+(A>>6|A>>3&8)<<4|(15&e)+(e>>6|e>>3&8)}function I(A,e,t){let r=0;for(let i=0;i<t;i++){let t=e[i]>>>4;A[r++]=t>9?t+87:t+48,t=15&e[i],A[r++]=t>9?t+87:t+48}return String.fromCharCode.apply(null,A)}let l=null!==B?A=>{if("string"==typeof A){let e=B.from(A,"utf8");return new Uint8Array(e.buffer,e.byteOffset,e.length)}if(B.isBuffer(A))return new Uint8Array(A.buffer,A.byteOffset,A.length);if(ArrayBuffer.isView(A))return new Uint8Array(A.buffer,A.byteOffset,A.byteLength);throw Error("Invalid data type!")}:A=>{if("string"==typeof A)return s.encode(A);if(ArrayBuffer.isView(A))return new Uint8Array(A.buffer,A.byteOffset,A.byteLength);throw Error("Invalid data type!")},E="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",c=new Uint8Array(256);for(let A=0;A<E.length;A++)c[E.charCodeAt(A)]=A;let Q=new a,h=new Map;new a,new a,new a,new a,new a,new a,new a;var u,C,f,p,y,k={name:"md5",data:"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",hash:"42fa4d29"};let w=new a,d=null;function F(A){if(null===d)return(function(A,e,t){return n(this,void 0,void 0,function*(){let t=yield A.lock(),r=yield function(A,e){return n(this,void 0,void 0,function*(){let t=null,r=null,i=!1;if("undefined"==typeof WebAssembly)throw Error("WebAssembly is not supported in this environment!");let a=()=>new DataView(t.exports.memory.buffer).getUint32(t.exports.STATE_SIZE,!0),o=Q.dispatch(()=>n(this,void 0,void 0,function*(){if(!h.has(A.name)){let e=function(A){let e=function(A){let e=Math.floor(.75*A.length),t=A.length;return"="===A[t-1]&&(e-=1,"="===A[t-2]&&(e-=1)),e}(A),t=A.length,r=new Uint8Array(e),i=0;for(let e=0;e<t;e+=4){let t=c[A.charCodeAt(e)],n=c[A.charCodeAt(e+1)],a=c[A.charCodeAt(e+2)],o=c[A.charCodeAt(e+3)];r[i]=t<<2|n>>4,r[i+=1]=(15&n)<<4|a>>2,r[i+=1]=(3&a)<<6|63&o,i+=1}return r}(A.data),t=WebAssembly.compile(e);h.set(A.name,t)}let e=yield h.get(A.name);t=yield WebAssembly.instantiate(e,{})})),B=(A=null)=>{i=!0,t.exports.Hash_Init(A)},s=A=>{let e=0;for(;e<A.length;){let i=A.subarray(e,e+16384);e+=i.length,r.set(i),t.exports.Hash_Update(i.length)}},E=A=>{if(!i)throw Error("update() called before init()");s(l(A))},u=new Uint8Array(32),C=(A,n=null)=>{if(!i)throw Error("digest() called before init()");return(i=!1,t.exports.Hash_Final(n),"binary"===A)?r.slice(0,16):I(u,r,e)},f=A=>"string"==typeof A?A.length<4096:A.byteLength<16384,p=f;switch(A.name){case"argon2":case"scrypt":p=()=>!0;break;case"blake2b":case"blake2s":p=(A,e)=>e<=512&&f(A);break;case"blake3":p=(A,e)=>0===e&&f(A);break;case"xxhash64":case"xxhash3":case"xxhash128":p=()=>!1}return yield n(this,void 0,void 0,function*(){t||(yield o);let A=t.exports.Hash_GetBuffer();r=new Uint8Array(t.exports.memory.buffer,A,16384)}),{getMemory:()=>r,writeMemory:(A,e=0)=>{r.set(A,e)},getExports:()=>t.exports,setMemorySize:A=>{t.exports.Hash_SetMemorySize(A);let e=t.exports.Hash_GetBuffer();r=new Uint8Array(t.exports.memory.buffer,e,A)},init:B,update:E,digest:C,save:()=>{if(!i)throw Error("save() can only be called after init() and before digest()");let e=t.exports.Hash_GetState(),r=a(),n=new Uint8Array(t.exports.memory.buffer,e,r),o=new Uint8Array(4+r);return function(A,e){let t=e.length>>1;for(let r=0;r<t;r++){let t=r<<1;A[r]=g(e.charCodeAt(t),e.charCodeAt(t+1))}}(o,A.hash),o.set(n,4),o},load:e=>{if(!(e instanceof Uint8Array))throw Error("load() expects an Uint8Array generated by save()");let r=t.exports.Hash_GetState(),n=a(),o=4+n,B=t.exports.memory.buffer;if(e.length!==o)throw Error(`Bad state length (expected ${o} bytes, got ${e.length})`);if(!function(A,e){if(A.length!==2*e.length)return!1;for(let t=0;t<e.length;t++){let r=t<<1;if(e[t]!==g(A.charCodeAt(r),A.charCodeAt(r+1)))return!1}return!0}(A.hash,e.subarray(0,4)))throw Error("This state was written by an incompatible hash implementation");let s=e.subarray(4);new Uint8Array(B,r,n).set(s),i=!0},calculate:(A,i=null,n=null)=>{if(!p(A,i))return B(i),E(A),C("hex",n);let a=l(A);return r.set(a),t.exports.Hash_Calculate(a.length,i,n),I(u,r,e)},hashLength:e}})}(e,16);return t(),r})})(w,k,0).then(e=>(d=e).calculate(A));try{let e=d.calculate(A);return Promise.resolve(e)}catch(A){return Promise.reject(A)}}new a,new a,new a,new a,new a,new a,new a,new a,new a,new a,new a,new a,new a,new a,(p=C||(C={}))[p.INIT=0]="INIT",p[p.CHUNK=1]="CHUNK",p[p.DONE=2]="DONE",(y=f||(f={})).RUNNING="running",y.WAITING="waiting";class q{worker;status;constructor(A){this.worker=A,this.status="waiting"}run(A,e,t){return this.status="running",new Promise((r,i)=>{this.worker.onmessage=({data:A})=>{let{label:i,content:n}=A;i===C.DONE&&n&&(e[t]=n.chunk,this.status="waiting",r(n.result))},this.worker.onerror=A=>{this.status="waiting",i(A)},this.worker.postMessage(A,[A])})}}class x{pool=[];maxWorkerCount;curRunningCount=new r(0);results=[];constructor(A=navigator.hardwareConcurrency||4){this.maxWorkerCount=A}exec(A){this.results.length=0;let e=A.map((A,e)=>({data:A,index:e}));return new Promise(t=>{this.curRunningCount.subscribe(r=>{if(r<this.maxWorkerCount&&0!==e.length){let t=this.maxWorkerCount-r;t>A.length&&(t=A.length);let i=[];for(let A of this.pool)if(A.status===f.WAITING&&(i.push(A),i.length===t))break;let n=e.splice(0,t);this.curRunningCount.next(this.curRunningCount.value+t),i.forEach((e,t)=>{let r=n[t];e.run(r.data,A,r.index).then(A=>{this.results[r.index]=A}).catch(A=>{this.results[r.index]=A}).finally(()=>{this.curRunningCount.next(this.curRunningCount.value-1)})})}0===this.curRunningCount.value&&0===e.length&&t(this.results)})})}}class m extends x{constructor(A){super(A),this.pool=Array.from({length:this.maxWorkerCount}).map(()=>new q(new e))}}class S extends x{constructor(A=navigator.hardwareConcurrency||4){super(A),this.pool=Array.from({length:this.maxWorkerCount}).map(()=>new q(new t))}}class N{MAX_WORKERS;md5SingleWorkerPool;crc32SingleWorkerPool;constructor(A){this.MAX_WORKERS=A}getMD5ForFiles(A){return void 0===this.md5SingleWorkerPool&&(this.md5SingleWorkerPool=new m(this.MAX_WORKERS)),this.md5SingleWorkerPool.exec(A)}getCRC32ForFiles(A){return void 0===this.crc32SingleWorkerPool&&(this.crc32SingleWorkerPool=new S(this.MAX_WORKERS)),this.crc32SingleWorkerPool.exec(A)}}class R{h;l;r;constructor(A,e=null,t=null){this.h=A,this.l=e,this.r=t}}class b{root=new R("");leafs=[];async init(A){if(0===A.length)throw Error("Empty Nodes");"string"==typeof A[0]?this.leafs=A.map(A=>new R(A)):this.leafs=A,this.root=await this.buildTree()}getRootHash(){return this.root.h}async buildTree(){let A=this.leafs;for(;A.length>1;){let e=[];for(let t=0;t<A.length;t+=2){let r=A[t],i=t+1<A.length?A[t+1]:null,n=await this.calculateHash(r,i);e.push(new R(n,r,i))}A=e}return A[0]}serialize(){let A=e=>null===e?null:{h:e.h,l:A(e.l),r:A(e.r)};return JSON.stringify(A(this.root))}static async deserialize(A){let e=JSON.parse(A),t=A=>null===A?null:new R(A.h,t(A.l),t(A.r)),r=t(e);if(!r)throw Error("Invalid serialized tree data");let i=A=>null===A.l&&null===A.r?[A]:[...A.l?i(A.l):[],...A.r?i(A.r):[]],n=i(r),a=new b;return await a.init(n),a}async calculateHash(A,e){return e?F(A.h+e.h):A.h}}let J=null;async function G(A,e=10,t=8){null===J&&(J=new N(t));let r=A.size/1e3,n={name:A.name,size:r,lastModified:A.lastModified,type:A.type},a=function(A,e=1){let t=1048576*e,r=[],i=0;for(;i<A.size;)r.push(A.slice(i,i+t)),i+=t;return r}(A,e),o=[];if(1===a.length)o=[await F(new Uint8Array(await a[0].arrayBuffer()))];else{let A=[],e=function(A,e){let t=[],r=[];return A.forEach(A=>{r.push(A),8===r.length&&(t.push(r),r=[])}),0!==r.length&&t.push(r),t}(a,0);for(let t of(console.log("chunksBlob",a.length),console.log("BORDER_COUNT",100),e.map(e=>async()=>(A.length=0,A=await i(e),a.length<=100?await J.getMD5ForFiles(A):await J.getCRC32ForFiles(A))))){let A=await t();o.push(...A)}}let B=new b;return await B.init(o),{chunksBlob:a,chunksHash:o,merkleHash:B.getRootHash(),metadata:n}}A.getFileHashInfo=G}({},Worker,Worker$1);
